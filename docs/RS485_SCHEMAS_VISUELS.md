# SchÃ©mas Visuels RS485 - ReprÃ©sentation ASCII

## 1. Architecture ComplÃ¨te du SystÃ¨me

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ                        COMPOSTIÃˆRE MONITORING                   â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         ESP32 DEVKIT (Master)      â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
    â”‚  â”‚ GPIO16 : RX  â•‘ GPIO17 : TX    â”‚â”‚   MicrocontrÃ´leur
    â”‚  â”‚ GPIO4  : DE/RE (Direction)   â”‚â”‚   3.3V TTL
    â”‚  â”‚ GPIO21 : SDA â•‘ GPIO22 : SCL   â”‚â”‚   (I2C aussi)
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
    â”‚              â”‚                     â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
    â”‚  â”‚   Max485 Module    â”‚            â”‚
    â”‚  â”‚  (RS485 Driver)    â”‚            â”‚
    â”‚  â”‚ [DI] [RO] [RE/DE]  â”‚            â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜            â”‚
    â”‚         â”‚      â”‚                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚      â”‚
          [A] â”‚      â”‚ [B]
              â”‚      â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                         â”‚
 â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”
 â”‚      RS485 Bus   â”‚ (Twisted Pair) â”‚
 â”‚   120Î© Term      â”‚                â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                â”‚
      [A] â”‚                â”‚ [B]
          â”‚                â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Capteur #1 â”‚    â”‚ Capteur #2 â”‚    â”‚Capteur #3â”‚
    â”‚ SHT20     â”‚    â”‚  SHT20    â”‚    â”‚  SHT20  â”‚
    â”‚Addr: 1   â”‚    â”‚ Addr: 2   â”‚    â”‚ Addr: 3 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    â€¢ Chaque capteur a une adresse Modbus unique
    â€¢ Tous sur le mÃªme bus RS485 (2 fils)
    â€¢ Communication en sequence (pas simultanÃ©)
    â€¢ Chaque lecture : ~40-50ms (incluant timeout)
```

---

## 2. Transmission DiffÃ©rentielle RS485

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LOGIQUE DIFFÃ‰RENTIELLE                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   Ligne A (Non-inversÃ©e)        Ligne B (InversÃ©e)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   +12V      â”‚               â”‚   -12V      â”‚  BIT LOGIQUE 1
   â”‚   (Marque)  â”‚               â”‚   (Marque)  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   
   DiffÃ©rence : V(A) - V(B) = (+12V) - (-12V) = +24V âœ“ BIT = 1
   
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   -12V      â”‚               â”‚   +12V      â”‚  BIT LOGIQUE 0
   â”‚   (Espace)  â”‚               â”‚   (Espace)  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   
   DiffÃ©rence : V(A) - V(B) = (-12V) - (+12V) = -24V âœ“ BIT = 0

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ADVANTAGES DE LA LOGIQUE DIFFÃ‰RENTIELLE :       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ Immun au bruit en mode commun                 â”‚
â”‚ âœ“ Grande diffÃ©rence de tension (+24V vs Â±3.3V)  â”‚
â”‚ âœ“ Permet de longs cÃ¢bles (1200m max)            â”‚
â”‚ âœ“ Multiple maÃ®tres/esclaves possibles           â”‚
â”‚ âœ“ Taux d'erreur trÃ¨s faible                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

EXEMPLE - Bit 1 dans le bruit :

Sans RS485 (TTL simple) :        Avec RS485 (DiffÃ©rentiel) :
    Signal ideal : â”Œâ”€â”               Signal A :  â”Œâ”€â”€â”
                  â”‚ â”‚ Bruit â†’                   â”‚  â”‚ Bruit
                  â””â”€â”˜ ajoutÃ© :       Signal B :    â””â”€â”€â”˜
    Signal reÃ§u:   â”Œâ”€â”                                
                â”Œâ”€â”˜ â””â”€â”  âŒ ERREUR   DiffÃ©rence : â”Œâ”€â”€â”
                                                  â”‚  â”‚ â†’ âœ… OK
                                                  â””â”€â”€â”˜
```

---

## 3. Flux d'une RequÃªte Modbus

```
Ã‰TAPE 1 : CONSTRUCTION TRAME
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DonnÃ©es Ã  envoyer (6 octets) :                      â”‚
â”‚  [Addr] [Func] [Reg.H] [Reg.L] [Qty.H] [Qty.L]    â”‚
â”‚  [0x01] [0x04] [0x00] [0x01] [0x00] [0x01]       â”‚
â”‚                                                    â”‚
â”‚  â–¼ Calcul CRC16 (polynÃ´me 0xA001) â–¼              â”‚
â”‚                                                    â”‚
â”‚  CRC = 0x41C6                                      â”‚
â”‚                                                    â”‚
â”‚  Trame finale (8 octets) :                         â”‚
â”‚  [0x01][0x04][0x00][0x01][0x00][0x01][0xC6][0x41]
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚        DonnÃ©es originales      â””â”€ CRC ajoutÃ©
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ã‰TAPE 2 : ACTIVATION Ã‰METTEUR
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GPIO4 (DE/RE pin) :                                 â”‚
â”‚                                                     â”‚
â”‚  AVANT :  LOW  [ESP32 en Ã©coute]                   â”‚
â”‚           â”‚                                         â”‚
â”‚           â”œâ”€ Max485 : RO activÃ©, DI ignorÃ©         â”‚
â”‚           â”œâ”€ Bus RS485 : Libre                     â”‚
â”‚           â””â”€ ESP32 : Peut recevoir                 â”‚
â”‚                                                     â”‚
â”‚  APRÃˆS :  HIGH [ESP32 envoie]                      â”‚
â”‚           â”‚                                         â”‚
â”‚           â”œâ”€ Max485 : DI actif, RO en HiZ          â”‚
â”‚           â”œâ”€ Bus RS485 : PilotÃ© par ESP32          â”‚
â”‚           â””â”€ ESP32 : PrÃªt Ã  transmettre            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ã‰TAPE 3 : TRANSMISSION 8 OCTETS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Vitesse : 9600 baud = 10 bits/octet = 1.04ms     â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€ Octet #1         Temps : 0-1.04ms              â”‚
â”‚  â”‚ [01010000] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚                                  â”‚              â”‚
â”‚  â”œâ”€ Octet #2         Temps : 1.04-2.08ms           â”‚
â”‚  â”‚ [00000100] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”€ Envoi      â”‚
â”‚  â”‚                                  â”‚  sur        â”‚
â”‚  â”‚ ... (6 octets restants)          â”‚  RS485      â”‚
â”‚  â”‚                                  â”‚  Bus        â”‚
â”‚  â””â”€ Octet #8         Temps : 7.3-8.34ms            â”‚
â”‚    [01000001] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                     â”‚
â”‚  TOTAL : 8.34ms pour 8 octets                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ã‰TAPE 4 : RETOUR MODE RÃ‰CEPTEUR
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AprÃ¨s flush() :                                     â”‚
â”‚                                                     â”‚
â”‚  GPIO4 (DE/RE pin) : LOW [Retour Ã  l'Ã©coute]      â”‚
â”‚           â”‚                                         â”‚
â”‚           â”œâ”€ Max485 : RO rÃ©activÃ©                  â”‚
â”‚           â”œâ”€ Bus RS485 : PrÃªt Ã  recevoir           â”‚
â”‚           â””â”€ ESP32 : En attente de rÃ©ponse         â”‚
â”‚                                                     â”‚
â”‚  TIMEOUT : 200ms maximum d'attente                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ã‰TAPE 5 : RÃ‰CEPTION 7 OCTETS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Capteur rÃ©pond avec 7 octets :                     â”‚
â”‚                                                     â”‚
â”‚  [Addr][Func][Len][Data_H][Data_L][CRC_L][CRC_H] â”‚
â”‚  [0x01][0x04][0x02][0x00][0xEB][0x??][0x??]      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚             â”‚      â”‚                     â”‚
â”‚      Echo      DonnÃ©es du    CRC                   â”‚
â”‚   (validation) registre      (vÃ©rification)        â”‚
â”‚                                                     â”‚
â”‚  Temps de rÃ©ception : 7.3ms                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ã‰TAPE 6 : PARSING
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ“ VÃ©rifier : response[0] == address (0x01)       â”‚
â”‚  âœ“ VÃ©rifier : response[1] == fonction (0x04)      â”‚
â”‚  âœ“ Extraire : rawValue = (response[3] << 8)      â”‚
â”‚                         | response[4]             â”‚
â”‚               = (0x00 << 8) | 0xEB = 0xEB = 235  â”‚
â”‚  âœ“ Convertir : 235 / 10.0 = 23.5Â°C               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Timeline ComplÃ¨te d'une Lecture

```
                    TEMPS (millisecondes)
    0    5    10    15    20    25    30    35    40    45    50
    |    |    |     |     |     |     |     |     |     |     |
    â–¼    â–¼    â–¼     â–¼     â–¼     â–¼     â–¼     â–¼     â–¼     â–¼     â–¼
    
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                               â”‚
â”‚ PHASE 1: Ã‰MISSION (0-8.3ms)                                 â”‚
â”‚ â”œâ”€ GPIO4 = HIGH (Mode TX)                                  â”‚
â”‚ â”œâ”€ Envoyer 8 octets @ 9600 baud                           â”‚
â”‚ â”‚  1 octet = 10 bits = 1.04ms                             â”‚
â”‚ â”‚  8 octets = 8.34ms                                       â”‚
â”‚ â””â”€ Attendre flush()                                        â”‚
â”‚    â”‚                                                        â”‚
â”‚    â””â”€ Ã‰MISSION             â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘                         â”‚
â”‚                            0-8.3ms                          â”‚
â”‚                                                               â”‚
â”œâ”€ GPIO4 = LOW (Mode RX)                                     â”‚
â”‚                                                               â”‚
â”‚ PHASE 2: PROPAGATION RÃ‰SEAU (8.3-10ms)                     â”‚
â”‚ â””â”€ Signal se propage sur le bus RS485                      â”‚
â”‚    â”‚                                                        â”‚
â”‚    â””â”€ PROPAGATION          â–‘â–‘                              â”‚
â”‚                            8.3-10ms                         â”‚
â”‚                                                               â”‚
â”‚ PHASE 3: RÃ‰CEPTION CAPTEUR (10-15ms)                       â”‚
â”‚ â”œâ”€ Capteur reÃ§oit la trame                                 â”‚
â”‚ â”œâ”€ Valide CRC                                              â”‚
â”‚ â””â”€ DÃ©code l'adresse et la fonction                         â”‚
â”‚    â”‚                                                        â”‚
â”‚    â””â”€ DÃ‰CODAGE CAPTEUR      â–‘â–‘â–‘â–‘â–‘                          â”‚
â”‚                             10-15ms                         â”‚
â”‚                                                               â”‚
â”‚ PHASE 4: TRAITEMENT (15-25ms)                              â”‚
â”‚ â”œâ”€ AccÃ¨s au registre 0x0001                                â”‚
â”‚ â”œâ”€ Lecture mÃ©moire EEPROM                                  â”‚
â”‚ â”œâ”€ Construction rÃ©ponse                                    â”‚
â”‚ â””â”€ Calcul CRC rÃ©ponse                                      â”‚
â”‚    â”‚                                                        â”‚
â”‚    â””â”€ TRAITEMENT CAPTEUR    â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘                     â”‚
â”‚                             15-25ms                         â”‚
â”‚                                                               â”‚
â”‚ PHASE 5: Ã‰MISSION RÃ‰PONSE (25-32.3ms)                      â”‚
â”‚ â”œâ”€ GPIO4 du capteur = HIGH (Mode TX)                       â”‚
â”‚ â”œâ”€ Envoyer 7 octets @ 9600 baud                           â”‚
â”‚ â”‚  7 octets = 7.3ms                                        â”‚
â”‚ â””â”€ GPIO4 = LOW (fin Ã©mission)                              â”‚
â”‚    â”‚                                                        â”‚
â”‚    â””â”€ RÃ‰PONSE DU CAPTEUR    â–‘â–‘â–‘â–‘â–‘â–‘â–‘                        â”‚
â”‚                             25-32.3ms                       â”‚
â”‚                                                               â”‚
â”‚ PHASE 6: PROPAGATION RETOUR (32.3-34ms)                    â”‚
â”‚ â””â”€ Signal revient Ã  l'ESP32                                â”‚
â”‚    â”‚                                                        â”‚
â”‚    â””â”€ PROPAGATION RETOUR    â–‘â–‘                             â”‚
â”‚                             32.3-34ms                       â”‚
â”‚                                                               â”‚
â”‚ PHASE 7: RÃ‰CEPTION ESP32 (34-40ms)                         â”‚
â”‚ â”œâ”€ RÃ©ception 7 octets (7.3ms)                              â”‚
â”‚ â”œâ”€ Parsing des donnÃ©es                                     â”‚
â”‚ â”œâ”€ Validation et conversion                                â”‚
â”‚ â””â”€ Retour du rÃ©sultat                                      â”‚
â”‚    â”‚                                                        â”‚
â”‚    â””â”€ RÃ‰CEPTION ESP32        â–‘â–‘â–‘â–‘â–‘â–‘                        â”‚
â”‚                             34-40ms                         â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RÃ‰SUMÃ‰ TEMPOREL :                                            â”‚
â”‚  â€¢ Ã‰mission                    : 8.3ms                        â”‚
â”‚  â€¢ Propagation (aller/retour)  : 4ms (max)                   â”‚
â”‚  â€¢ Traitement capteur          : 10-15ms                     â”‚
â”‚  â€¢ RÃ©ception ESP32             : 7-8ms                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”‚
â”‚  TEMPS TOTAL (normal)          : 30-40ms                     â”‚
â”‚  TIMEOUT programmÃ©             : 200ms (5x de sÃ©curitÃ©)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Structure DÃ©taillÃ©e d'une Trame

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               TRAME MODBUS FC04                      â”‚
â”‚          (Read Input Registers)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

OCTET 0 : SLAVE ADDRESS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  0 0 0 0 0 0 0 1  = 0x01 (Capteur #1)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Bit7 Bit6... Bit0
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  Valeurs possibles : 1-247
  (1, 2, 3 dans notre projet)
  UtilisÃ© pour :
  â€¢ Router le message au bon capteur
  â€¢ Identifier la rÃ©ponse
  â€¢ Adresse unique sur le bus

OCTET 1 : FUNCTION CODE
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  0 0 0 0 0 1 0 0  = 0x04 (Read Input Registers)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Bit7 Bit6... Bit0
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  Valeurs courantes :
  â€¢ 0x03 = Read Holding Registers
  â€¢ 0x04 = Read Input Registers  â† SHT20
  â€¢ 0x06 = Write Single Register
  â€¢ 0x10 = Write Multiple Registers
  UtilisÃ© pour :
  â€¢ Indiquer l'opÃ©ration Ã  effectuer
  â€¢ SHT20 = Input Registers (lecture seul)

OCTET 2-3 : STARTING REGISTER ADDRESS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  0x00  |  0x01   â”‚  = Registre 0x0001
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ MSB     â”‚  LSB    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  Format : Big-Endian (MSB d'abord)
  Registres SHT20 :
  â€¢ 0x0001 = TempÃ©rature
  â€¢ 0x0002 = HumiditÃ©
  â€¢ 0x0003 = Status

OCTET 4-5 : QUANTITY OF INPUT REGISTERS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  0x00  |  0x01   â”‚  = 1 registre Ã  lire
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ MSB     â”‚  LSB    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  Toujours 0x0001 dans notre cas
  (Lire 1 registre = 2 octets de donnÃ©es)

OCTET 6-7 : CRC16
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  0xC6  |  0x41   â”‚  = CRC calculÃ©
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ LSB     â”‚  MSB    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  âš ï¸  Format : LITTLE-ENDIAN (LSB d'abord)
  (Inverse de la normale pour Modbus RTU)
  Calcul :
  â€¢ EntrÃ©e : Octets 0-5
  â€¢ PolynÃ´me : 0xA001
  â€¢ Format : LSB en premier octet

RÃ‰SUMÃ‰ - EXEMPLE RÃ‰EL :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Lire tempÃ©rature du capteur 1 :                  â”‚
â”‚                                                   â”‚
â”‚  [0x01] [0x04] [0x00] [0x01] [0x00] [0x01]     â”‚
â”‚  [0xC6] [0x41]                                  â”‚
â”‚   â””â”€â”€â”˜   â””â”€â”€â”˜   â””â”€â”€â”¬â”€â”€â”˜   â””â”€â”€â”¬â”€â”€â”˜   â””â”€â”€â”¬â”€â”€â”˜   â”‚
â”‚   Addr  Func    Reg=    Qty=   CRC=           â”‚
â”‚    1     FC04   0x0001   1      CalculÃ©       â”‚
â”‚                                                   â”‚
â”‚  DÃ©codÃ© = "Capteur 1, lis registre 0x0001"    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. Processus CRC16 Visuel

```
CALCUL CRC16 MODBUS (Polynomial 0xA001)

DonnÃ©es d'entrÃ©e : [0x01, 0x04, 0x00, 0x01, 0x00, 0x01]

Ã‰tape 1 : Initialiser CRC = 0xFFFF
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CRC = 1111111111111111       â”‚
â”‚       FFFF en hexadÃ©cimal    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ã‰tape 2 : Pour chaque octet
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Octet 1 : 0x01 = 00000001             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ OpÃ©ration :                            â”‚
â”‚ 1. CRC XOR 0x01                       â”‚
â”‚    1111111111111111 XOR                â”‚
â”‚    0000000000000001 =                  â”‚
â”‚    1111111111111110  (0xFFFE)         â”‚
â”‚                                        â”‚
â”‚ 2. Pour chaque bit (8 itÃ©rations) :  â”‚
â”‚    â”œâ”€ Si LSB (bit 0) = 1 :           â”‚
â”‚    â”‚  â””â”€ DÃ©caler droite              â”‚
â”‚    â”‚     XOR avec 0xA001              â”‚
â”‚    â”‚  Sinon juste dÃ©caler             â”‚
â”‚    â””â”€ RÃ©sultat : 0x30FD              â”‚
â”‚                                        â”‚
â”‚ Ã‰tat : CRC = 0x30FD                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Octet 2 : 0x04
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CRC XOR 0x04, 8 itÃ©rations XOR        â”‚
â”‚ RÃ©sultat : CRC = 0x0CDD               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Octet 3 : 0x00
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RÃ©sultat : CRC = 0x0CDD (identique)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Octet 4 : 0x01
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RÃ©sultat : CRC = ???? (nouveau calcul) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

... (Octets 5-6 traitÃ©s de mÃªme)

CRC FINAL : 0x41C6
â”œâ”€ EnvoyÃ© comme : [0xC6] [0x41]
â”œâ”€ (LSB d'abord = Little-Endian)
â””â”€ PlacÃ© dans les octets 6-7

VÃ‰RIFICATION :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ã€ la rÃ©ception :                       â”‚
â”‚ 1. Recalculer le CRC des octets 0-5   â”‚
â”‚ 2. Comparer avec CRC reÃ§u (6-7)       â”‚
â”‚    Si Ã©gaux â†’ âœ… DonnÃ©es valides      â”‚
â”‚    Si diffÃ©rents â†’ âŒ Erreur transmission
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. Cycle Complet 3 Capteurs

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        LECTURE DES 3 CAPTEURS (Cycle Complet)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Temps      Ã‰vÃ©nement                      DurÃ©e
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
t=0ms      Capteur 1 : Lire TempÃ©rature  40ms
â”‚          â”œâ”€ Ã‰mission trame
â”‚          â”œâ”€ Attente rÃ©ponse (200ms timeout)
â”‚          â”œâ”€ RÃ©ception et parsing
â”‚          â–¼                                â–¼
t=40ms     Delay(100)                    100ms
â”‚          â””â”€ Petit dÃ©lai entre temp/humidity
â”‚          â–¼
t=140ms    Capteur 1 : Lire HumiditÃ©     40ms
â”‚          â”œâ”€ Ã‰mission trame
â”‚          â”œâ”€ Attente rÃ©ponse
â”‚          â”œâ”€ RÃ©ception et parsing
â”‚          â–¼                                â–¼
t=180ms    Delay(500)                   500ms
â”‚          â””â”€ DÃ©lai avant capteur suivant
â”‚          â–¼
t=680ms    Capteur 2 : Lire TempÃ©rature  40ms
â”‚          (Identique au capteur 1)
â”‚          â–¼                                â–¼
t=720ms    Delay(100)                    100ms
â”‚          â–¼
t=820ms    Capteur 2 : Lire HumiditÃ©     40ms
â”‚          â–¼                                â–¼
t=860ms    Delay(500)                   500ms
â”‚          â–¼
t=1360ms   Capteur 3 : Lire TempÃ©rature  40ms
â”‚          â–¼                                â–¼
t=1400ms   Delay(100)                    100ms
â”‚          â–¼
t=1500ms   Capteur 3 : Lire HumiditÃ©     40ms
â”‚          â–¼                                â–¼
t=1540ms   Delay(500)                   500ms
â”‚          (Optionnel, mais dans le code)
â”‚          â–¼
t=2040ms   CYCLE TERMINÃ‰
â”‚
â”‚          Affichage serial
â”‚          â”œâ”€ Capteur 1: 23.5Â°C | 45.2%RH
â”‚          â”œâ”€ Capteur 2: 24.1Â°C | 44.8%RH
â”‚          â””â”€ Capteur 3: 23.8Â°C | 45.5%RH
â”‚
â”‚          Delay(2000)                  2000ms
â”‚          â–¼
t=4040ms   Retour au dÃ©but (Capteur 1 tempÃ©rature)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RÃ‰CAPITULATIF :                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Temps lecture effective : 240ms        â”‚
â”‚ Temps delays : 1800ms                  â”‚
â”‚ Temps total boucle : 2040ms            â”‚
â”‚ FrÃ©quence : 1 cycle = 2 secondes      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. Machine d'Ã‰tat RS485

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           MACHINE D'Ã‰TAT COMMUNICATION RS485               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   IDLE     â”‚  (Attente)
                    â”‚ GPIO4=LOW  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                           â”‚
                    Appel readRS485Register()
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ 1. CONSTRUCTION    â”‚
                    â”‚ PrÃ©parer trame     â”‚
                    â”‚ Calculer CRC       â”‚
                    â”‚ Nettoyer buffer RX â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ 2. TX ENABLE       â”‚
                    â”‚ GPIO4 = HIGH       â”‚
                    â”‚ Mode Ã©metteur ON   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ 3. TRANSMIT        â”‚
                    â”‚ Envoyer 8 octets   â”‚
                    â”‚ @ 9600 baud        â”‚
                    â”‚ (8.3ms)            â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ 4. FLUSH & SWITCH  â”‚
                    â”‚ Attendre fin TX    â”‚
                    â”‚ GPIO4 = LOW        â”‚
                    â”‚ Mode rÃ©cepteur ON  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ 5. WAIT RESPONSE   â”‚
                    â”‚ Boucle d'attente   â”‚
                    â”‚ Timeout : 200ms    â”‚
                    â”‚ Attendre â‰¥7 octets â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                    â”‚
            TIMEOUT (âŒ)      RÃ‰PONSE OK (âœ…)
                    â”‚                    â”‚
                    â–¼                    â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Return    â”‚      â”‚ 6. PARSE RESPONSE  â”‚
            â”‚ NAN       â”‚      â”‚ Valider adresse    â”‚
            â”‚           â”‚      â”‚ Valider fonction   â”‚
            â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â”‚ Extraire donnÃ©es   â”‚
                  â”‚            â”‚ Convertir en Â°C    â”‚
                  â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚                     â”‚
                  â”‚                     â–¼
                  â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚            â”‚ Return value     â”‚
                  â”‚            â”‚ (float)          â”‚
                  â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚                     â”‚
                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ RETOUR Ã€ IDLE      â”‚
                  â”‚ GPIO4 = LOW        â”‚
                  â”‚ En Ã©coute          â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

NOTES :
â€¢ Chaque lecture = 1 passage complet
â€¢ Pas d'interruption
â€¢ Bloquant (fonction attend la rÃ©ponse)
â€¢ Timeout sÃ»r (200ms pour ~40ms max de rÃ©ponse)
```

---

## 9. Comparaison Logique TTL vs DiffÃ©rentielle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         TRANSMISSION BIT "1" EN PRÃ‰SENCE BRUIT       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

LOGIQUE TTL (RS232) - âŒ Sensible au bruit
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                          â”‚
â”‚  Signal idÃ©al (5V) :     â”Œâ”€â”€â”€â”€â”€â”€â”       â”‚
â”‚                          â”‚      â”‚       â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚  Bruit ajoutÃ© (+1V) :              ~~~  â”‚
â”‚                                         â”‚
â”‚  Signal reÃ§u + bruit :  â”Œâ”€â” â”Œâ”€â”€â”      â”‚
â”‚                        â”‚ â”‚ â”‚  â”‚  Erreur !
â”‚                        â””â”€â””â”€â”˜  â””â”€     â”‚
â”‚                                         â”‚
â”‚  RÃ©cepteur voit : 1,0,1,1,1,0,0,0    â”‚
â”‚  Au lieu de :     1,1,1,1,1,1,1,1    â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

LOGIQUE DIFFÃ‰RENTIELLE RS485 - âœ… Immun au bruit
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                          â”‚
â”‚  Signal A idÃ©al (+12V) :  â”Œâ”€â”€â”€â”€â”€â”€â”      â”‚
â”‚                           â”‚      â”‚      â”‚
â”‚                           â””â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚  Signal B idÃ©al (-12V) :  â””â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                           â”Œ      â”      â”‚
â”‚  Bruit ajoutÃ© (+2V) : ~~~/      \~~~   â”‚
â”‚  (Mode commun)           \      /       â”‚
â”‚                                         â”‚
â”‚  Signal A reÃ§u :  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚                  â”‚    +12V    â”‚        â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  Signal B reÃ§u :  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                  â”Œ    -12V    â”        â”‚
â”‚                  â”‚            â”‚        â”‚
â”‚  DiffÃ©rence :    V(A)-V(B) = 24V       â”‚
â”‚  Bruit s'annule !                      â”‚
â”‚  RÃ©cepteur voit : BIT 1 = âœ… OK        â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

RÃ‰SUMÃ‰ :
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TTL (RS232)                          â”‚
â”‚ â”œâ”€ Distance : ~15m max              â”‚
â”‚ â”œâ”€ Bruit : -10dB                    â”‚
â”‚ â”œâ”€ Vitesse : 115200 baud            â”‚
â”‚ â””â”€ Appareils : 1 maÃ®tre + 1 esclave â”‚
â”‚                                      â”‚
â”‚ RS485 (DiffÃ©rentiel)                 â”‚
â”‚ â”œâ”€ Distance : 1200m                â”‚
â”‚ â”œâ”€ Bruit : -30dB (immun)           â”‚
â”‚ â”œâ”€ Vitesse : 9600-500k baud        â”‚
â”‚ â””â”€ Appareils : 1 maÃ®tre + 128 esclaves
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 10. Erreur Courante : Mauvais Mode Direction

```
SITUATION : GPIO4 reste Ã  HIGH (TX) toujours

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CODE PROBLÃ‰MATIQUE :                           â”‚
â”‚                                                â”‚
â”‚ void setup() {                                â”‚
â”‚   digitalWrite(RS485_DE_RE, HIGH);  âŒ ERREUR â”‚
â”‚   // Reste en mode TX pour toujours           â”‚
â”‚ }                                             â”‚
â”‚                                                â”‚
â”‚ void loop() {                                 â”‚
â”‚   digitalWrite(RS485_DE_RE, HIGH);  âŒ Inutileâ”‚
â”‚   RS485Serial.write(frame, 8);               â”‚
â”‚   RS485Serial.flush();                       â”‚
â”‚   digitalWrite(RS485_DE_RE, LOW);   âŒ Trop tardâ”‚
â”‚                                                â”‚
â”‚   // Ã€ ce stade, la rÃ©ception est impossible â”‚
â”‚ }                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

RÃ‰SULTAT : Les donnÃ©es ne sont jamais reÃ§ues

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GPIO4 Timeline (MAUVAIS)                  â”‚
â”‚                                           â”‚
â”‚ t=0      : HIGH (TX)  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                       â”‚                  â”‚
â”‚ t=8ms    : ... toujours HIGH ...         â”‚
â”‚                       â”‚                  â”‚
â”‚ t=40ms   : ... toujours HIGH ...         â”‚
â”‚           (Capteur envoie mais        â”‚
â”‚            ESP32 ne peut pas recevoir)   â”‚
â”‚                       â”‚                  â”‚
â”‚ t=50ms   : LOW   â”€â”€â”€â”€â”´â”€â”€                 â”‚
â”‚            (Trop tard !)                 â”‚
â”‚                                           â”‚
â”‚ âŒ AUCUNE DONNÃ‰E REÃ‡UE                   â”‚
â”‚                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SOLUTION CORRECTE :

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CODE CORRECT :                                 â”‚
â”‚                                                â”‚
â”‚ void setup() {                                â”‚
â”‚   pinMode(RS485_DE_RE, OUTPUT);              â”‚
â”‚   digitalWrite(RS485_DE_RE, LOW);  âœ… Repos   â”‚
â”‚ }                                             â”‚
â”‚                                                â”‚
â”‚ void sendFrame() {                           â”‚
â”‚   digitalWrite(RS485_DE_RE, HIGH);  âœ… TX    â”‚
â”‚   RS485Serial.write(frame, 8);              â”‚
â”‚   RS485Serial.flush();                      â”‚
â”‚   digitalWrite(RS485_DE_RE, LOW);  âœ… RX    â”‚
â”‚ }                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

RÃ‰SULTAT : Communication fluide

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GPIO4 Timeline (CORRECT)                  â”‚
â”‚                                           â”‚
â”‚ t=0    : HIGH (TX) â”Œâ”€â”€â”                  â”‚
â”‚                    â”‚  â”‚                  â”‚
â”‚ t=8ms  : LOW (RX)  â””â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚
â”‚                       â”‚                  â”‚
â”‚ t=40ms : RÃ©ception âœ… des donnÃ©es       â”‚
â”‚                       â”‚                  â”‚
â”‚ t=50ms : Retour   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”‚
â”‚         pour prochain cycle              â”‚
â”‚                                           â”‚
â”‚ âœ… COMMUNICATION OK                      â”‚
â”‚                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

Fin des schÃ©mas visuels. Consultez les documentations principales pour plus de dÃ©tails ! ğŸ“–
